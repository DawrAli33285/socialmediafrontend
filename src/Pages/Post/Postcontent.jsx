import './post.css'
import 'toastr/build/toastr.min.css';
import toastr from 'toastr'
import AudioPlayer from '../FeedPage/AudioPlayer';
import { add_remove_favourites } from '../../redux/slices/postSlices'
import React from 'react'
import store from '../../redux/store/store'
import {Link,useNavigate,useParams} from 'react-router-dom'
import { getSinglePost } from '../../redux/slices/postSlices'
import {useDispatch} from 'react-redux'
const Postcontent=()=>{
    const dispatch=useDispatch();
    const [post,setPost]=React.useState()
    const navigate=useNavigate();
    const [showdotpopup,setShowDotPopup]=React.useState(false)
    const [subscriptions,setSubscriptions]=React.useState([])
const [user,setUser]=React.useState("")
let {id}=useParams();
React.useEffect(()=>{
getPost();
setUser(store.getState().authenticationslices?.user?.user);

        // Subscribe to store changes
        const unsubscribe = store.subscribe(() => {
            setUser(store.getState().authenticationslices?.user?.user);
        });
//newposts
        // Unsubscribe from the store changes when the component unmounts
        return () => unsubscribe();
},[])



const getPost=async()=>{
    let data={
        id
    }
 let res=await dispatch(getSinglePost(data))
if(getSinglePost.rejected.match(res)){
    toastr.error(res.payload.error)
console.log(res)
}
if(getSinglePost.fulfilled.match(res)){
setPost(res.payload.post)
console.log('post fulfiled')
setSubscriptions(res?.payload?.subscriptions)
   console.log('subscriptions')
   console.log(res.payload.subscriptions)
}

}

  
const add_remove_reaction=async(postid,heart)=>{
let data={
    postid,
    user:user._id
}
    let res=await dispatch(add_remove_favourites(data))
    if(add_remove_favourites.rejected.match(res)){
        console.log(res)
        toastr.error(res.payload.error)
    }
    if(add_remove_favourites.fulfilled.match(res)){
if(heart==false){
        
    setPost((prev)=>{
    let old={...prev}
    old.favourites=[...old.favourites,user?._id]
    return old
    })
}else{
        
    setPost((prev)=>{
    let old={...prev}
    old.favourites=old.favourites.filter(u=>u!=user?._id)
    return old    
    
    })
}
    }

}


    return(
        <div  className="postcontent-div">              
           <div className="flex flex-row items-center space-x-3">

<Link to='/feed'>
<svg width="12" height="15" viewBox="0 0 12 21" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M9.66046 20.9999C9.41322 21.0007 9.16894 20.9512 8.94557 20.8552C8.72219 20.7591 8.52539 20.619 8.36964 20.4449L0.37647 11.4458C0.133064 11.1774 0 10.8408 0 10.4934C0 10.146 0.133064 9.80935 0.37647 9.54098L8.65097 0.541827C8.93187 0.235531 9.33552 0.0429128 9.77312 0.00634665C10.2107 -0.0302195 10.6464 0.0922618 10.9844 0.346846C11.3223 0.601429 11.5349 0.967262 11.5752 1.36386C11.6156 1.76047 11.4804 2.15535 11.1995 2.46165L3.80211 10.5009L10.9513 18.5401C11.1536 18.7603 11.2822 19.0284 11.3217 19.3127C11.3612 19.597 11.3101 19.8856 11.1743 20.1443C11.0385 20.4031 10.8237 20.6212 10.5555 20.7728C10.2872 20.9244 9.9766 21.0032 9.66046 20.9999Z" fill="white"/>
</svg>
</Link>

        <p>Retour</p>
           </div>
     <div style={{width:'90%'}}>
   <div className="post-threedots relative">
   <svg  className="cursor-pointer" data-key={1} onClick={(e)=>setShowDotPopup(!showdotpopup)} width="25" height="20" viewBox="0 0 32 7" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M16 0C15.2968 0 14.6093 0.205272 14.0246 0.589857C13.4399 0.974441 12.9842 1.52107 12.7151 2.16061C12.446 2.80015 12.3756 3.50388 12.5128 4.18282C12.65 4.86175 12.9886 5.48539 13.4858 5.97487C13.9831 6.46436 14.6166 6.7977 15.3063 6.93275C15.9961 7.0678 16.711 6.99848 17.3607 6.73358C18.0103 6.46867 18.5656 6.02007 18.9563 5.44449C19.347 4.86892 19.5556 4.19223 19.5556 3.5C19.5556 2.57174 19.181 1.6815 18.5142 1.02513C17.8474 0.36875 16.943 0 16 0ZM3.55556 0C2.85233 0 2.1649 0.205272 1.5802 0.589857C0.995488 0.974441 0.539764 1.52107 0.270652 2.16061C0.00154055 2.80015 -0.0688713 3.50388 0.0683206 4.18282C0.205512 4.86175 0.544146 5.48539 1.0414 5.97487C1.53865 6.46436 2.17219 6.7977 2.8619 6.93275C3.55161 7.0678 4.26652 6.99848 4.91621 6.73358C5.5659 6.46867 6.1212 6.02007 6.51189 5.44449C6.90258 4.86892 7.11111 4.19223 7.11111 3.5C7.11111 2.57174 6.73651 1.6815 6.06972 1.02513C5.40292 0.36875 4.49855 0 3.55556 0ZM28.4444 0C27.7412 0 27.0538 0.205272 26.4691 0.589857C25.8844 0.974441 25.4287 1.52107 25.1595 2.16061C24.8904 2.80015 24.82 3.50388 24.9572 4.18282C25.0944 4.86175 25.433 5.48539 25.9303 5.97487C26.4275 6.46436 27.0611 6.7977 27.7508 6.93275C28.4405 7.0678 29.1554 6.99848 29.8051 6.73358C30.4548 6.46867 31.0101 6.02007 31.4008 5.44449C31.7915 4.86892 32 4.19223 32 3.5C32 2.57174 31.6254 1.6815 30.9586 1.02513C30.2918 0.36875 29.3874 0 28.4444 0Z" fill="white"/>
</svg>
{showdotpopup?<div data-key={1} className="flex flex-col post-popupdiv">
<div>
<p className="cursor-pointer" onClick={()=>navigator.clipboard.writeText(window.location)}>Partager</p>
<p className="cursor-pointer"><Link to='/payments'>Signaler</Link></p>
    </div>
</div>:``}
   </div>

   <div className="flex flex-col post-content">
<div className="flex flex-row items-center">
<h2>
    {post?.creator.name}
</h2>
<svg width="20" height="15" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M19.1708 11.4595C18.8472 11.0326 18.673 10.5189 18.673 9.99166C18.673 9.46446 18.8472 8.95073 19.1708 8.52378L19.8339 7.64806C19.915 7.54113 19.9684 7.41731 19.9896 7.28682C20.0109 7.15632 19.9994 7.02287 19.9561 6.89744C19.9124 6.77333 19.8392 6.66057 19.7424 6.56797C19.6455 6.47537 19.5275 6.40545 19.3977 6.36367L18.3244 6.03006C17.7986 5.86796 17.3403 5.55037 17.0157 5.12314C16.691 4.6959 16.5168 4.18112 16.5182 3.6531V2.56887C16.5181 2.43723 16.4854 2.30748 16.4227 2.19024C16.3601 2.073 16.2693 1.97159 16.1578 1.89431C16.0463 1.81703 15.9173 1.76607 15.7812 1.7456C15.6452 1.72513 15.506 1.73574 15.3751 1.77654L14.2931 2.11015C13.7678 2.27262 13.2022 2.27219 12.6772 2.10891C12.1522 1.94563 11.6946 1.62788 11.3699 1.20107L10.7068 0.325346C10.6221 0.223853 10.5146 0.141899 10.3922 0.0855741C10.2699 0.029249 10.1358 0 10 0C9.86419 0 9.73012 0.029249 9.60776 0.0855741C9.4854 0.141899 9.37788 0.223853 9.29321 0.325346L8.63005 1.20107C8.30536 1.62788 7.84781 1.94563 7.32279 2.10891C6.79778 2.27219 6.2322 2.27262 5.70692 2.11015L4.62492 1.77654C4.49398 1.73574 4.3548 1.72513 4.21875 1.7456C4.0827 1.76607 3.95365 1.81703 3.84216 1.89431C3.73067 1.97159 3.6399 2.073 3.57727 2.19024C3.51465 2.30748 3.48195 2.43723 3.48185 2.56887V3.6531C3.48318 4.18112 3.30895 4.6959 2.9843 5.12314C2.65965 5.55037 2.20137 5.86796 1.67561 6.03006L0.602339 6.36367C0.472492 6.40545 0.354517 6.47537 0.257638 6.56797C0.160759 6.66057 0.0876024 6.77333 0.0438897 6.89744C0.000619933 7.02287 -0.0108687 7.15632 0.0103694 7.28682C0.0316075 7.41731 0.0849651 7.54113 0.166051 7.64806L0.82921 8.52378C1.1528 8.95073 1.32703 9.46446 1.32703 9.99166C1.32703 10.5189 1.1528 11.0326 0.82921 11.4595L0.166051 12.3353C0.0849651 12.4422 0.0316075 12.566 0.0103694 12.6965C-0.0108687 12.827 0.000619933 12.9605 0.0438897 13.0859C0.0876024 13.21 0.160759 13.3228 0.257638 13.4154C0.354517 13.508 0.472492 13.5779 0.602339 13.6197L1.67561 13.9533C2.20137 14.1154 2.65965 14.433 2.9843 14.8602C3.30895 15.2874 3.48318 15.8022 3.48185 16.3302V17.4145C3.48195 17.5461 3.51465 17.6758 3.57727 17.7931C3.6399 17.9103 3.73067 18.0117 3.84216 18.089C3.95365 18.1663 4.0827 18.2173 4.21875 18.2377C4.3548 18.2582 4.49398 18.2476 4.62492 18.2068L5.69819 17.8732C6.22459 17.708 6.79232 17.707 7.31933 17.8704C7.84634 18.0338 8.30536 18.3532 8.63005 18.7823L9.29321 19.658C9.37468 19.764 9.48111 19.8502 9.6039 19.9096C9.72668 19.969 9.86237 20 10 20C10.1376 20 10.2733 19.969 10.3961 19.9096C10.5189 19.8502 10.6253 19.764 10.7068 19.658L11.3699 18.7823C11.6952 18.3538 12.1542 18.0349 12.6811 17.8715C13.2079 17.7082 13.7753 17.7088 14.3018 17.8732L15.3751 18.2068C15.506 18.2476 15.6452 18.2582 15.7812 18.2377C15.9173 18.2173 16.0463 18.1663 16.1578 18.089C16.2693 18.0117 16.3601 17.9103 16.4227 17.7931C16.4854 17.6758 16.5181 17.5461 16.5182 17.4145V16.3302C16.5168 15.8022 16.691 15.2874 17.0157 14.8602C17.3403 14.433 17.7986 14.1154 18.3244 13.9533L19.3977 13.6197C19.5275 13.5779 19.6455 13.508 19.7424 13.4154C19.8392 13.3228 19.9124 13.21 19.9561 13.0859C19.9994 12.9605 20.0109 12.827 19.9896 12.6965C19.9684 12.566 19.915 12.4422 19.8339 12.3353L19.1708 11.4595ZM14.1098 8.91327L9.74695 13.0834C9.58332 13.2397 9.36142 13.3276 9.13004 13.3276C8.89866 13.3276 8.67676 13.2397 8.51313 13.0834L5.89539 10.5813C5.81205 10.5044 5.74558 10.4124 5.69985 10.3106C5.65412 10.2088 5.63005 10.0994 5.62904 9.98866C5.62803 9.87792 5.65011 9.7681 5.69398 9.6656C5.73786 9.5631 5.80265 9.46998 5.88458 9.39167C5.96651 9.31336 6.06393 9.25144 6.17117 9.2095C6.27841 9.16756 6.39331 9.14646 6.50917 9.14742C6.62503 9.14839 6.73953 9.17139 6.84598 9.2151C6.95244 9.25881 7.04873 9.32235 7.12922 9.40201L9.12742 11.3144L12.8734 7.73397C13.038 7.58204 13.2584 7.49798 13.4872 7.49988C13.716 7.50178 13.9348 7.58949 14.0966 7.74413C14.2584 7.89876 14.3501 8.10794 14.3521 8.32662C14.3541 8.5453 14.2662 8.75597 14.1072 8.91327H14.1098Z" fill="#5991C6"/>
</svg>

</div>
<h3>
    Titre
</h3>
<p>{post?.title}</p>
   <h3>Description</h3>
   <p>{post?.description}</p>
   </div>
<div style={{width:'100%'}} className="flex flex-row post-lastdiv">

{post?.premium==false?<AudioPlayer  audioUrl={post?.audio}/>:<AudioPlayer creator={post?.creator} isSub={subscriptions.find(u=>u?.creator?.toString()==post?.creator?._id?.toString())?true:false} prem={true} audioUrl={post?.audio}/>}
<svg width="25" height="20" viewBox="0 0 41 18" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M0.65625 17V15.5938L5.9375 9.8125C6.55729 9.13542 7.06771 8.54687 7.46875 8.04687C7.86979 7.54167 8.16667 7.06771 8.35938 6.625C8.55729 6.17708 8.65625 5.70833 8.65625 5.21875C8.65625 4.65625 8.52083 4.16927 8.25 3.75781C7.98438 3.34635 7.61979 3.02865 7.15625 2.80469C6.69271 2.58073 6.17188 2.46875 5.59375 2.46875C4.97917 2.46875 4.44271 2.59635 3.98438 2.85156C3.53125 3.10156 3.17969 3.45312 2.92969 3.90625C2.6849 4.35937 2.5625 4.89062 2.5625 5.5H0.71875C0.71875 4.5625 0.934896 3.73958 1.36719 3.03125C1.79948 2.32292 2.38802 1.77083 3.13281 1.375C3.88281 0.979166 4.72396 0.781249 5.65625 0.781249C6.59375 0.781249 7.42448 0.979166 8.14844 1.375C8.8724 1.77083 9.4401 2.30469 9.85156 2.97656C10.263 3.64844 10.4687 4.39583 10.4687 5.21875C10.4687 5.80729 10.362 6.38281 10.1484 6.94531C9.9401 7.5026 9.57552 8.125 9.05469 8.8125C8.53906 9.49479 7.82292 10.3281 6.90625 11.3125L3.3125 15.1562V15.2812H10.75V17H0.65625ZM15.3516 14.9531C14.9661 14.9531 14.6354 14.8151 14.3594 14.5391C14.0833 14.263 13.9453 13.9323 13.9453 13.5469C13.9453 13.1615 14.0833 12.8307 14.3594 12.5547C14.6354 12.2786 14.9661 12.1406 15.3516 12.1406C15.737 12.1406 16.0677 12.2786 16.3438 12.5547C16.6198 12.8307 16.7578 13.1615 16.7578 13.5469C16.7578 13.8021 16.6927 14.0365 16.5625 14.25C16.4375 14.4635 16.2682 14.6354 16.0547 14.7656C15.8464 14.8906 15.612 14.9531 15.3516 14.9531ZM15.3516 6.85938C14.9661 6.85938 14.6354 6.72135 14.3594 6.44531C14.0833 6.16927 13.9453 5.83854 13.9453 5.45312C13.9453 5.06771 14.0833 4.73698 14.3594 4.46094C14.6354 4.1849 14.9661 4.04687 15.3516 4.04687C15.737 4.04687 16.0677 4.1849 16.3438 4.46094C16.6198 4.73698 16.7578 5.06771 16.7578 5.45312C16.7578 5.70833 16.6927 5.94271 16.5625 6.15625C16.4375 6.36979 16.2682 6.54167 16.0547 6.67187C15.8464 6.79687 15.612 6.85938 15.3516 6.85938ZM25.6602 1V17H23.7227V3.03125H23.6289L19.7227 5.625V3.65625L23.7227 1H25.6602ZM35.3555 0.781249C36.0117 0.786458 36.668 0.911458 37.3242 1.15625C37.9805 1.40104 38.5794 1.80729 39.1211 2.375C39.6628 2.9375 40.0977 3.70573 40.4258 4.67969C40.7539 5.65365 40.918 6.875 40.918 8.34375C40.918 9.76562 40.7826 11.0286 40.5117 12.1328C40.2461 13.2318 39.8607 14.1589 39.3555 14.9141C38.8555 15.6693 38.2461 16.2422 37.5273 16.6328C36.8138 17.0234 36.0065 17.2187 35.1055 17.2187C34.2096 17.2187 33.4102 17.0417 32.707 16.6875C32.0091 16.3281 31.4362 15.8307 30.9883 15.1953C30.5456 14.5547 30.2617 13.8125 30.1367 12.9687H32.043C32.2148 13.7031 32.556 14.3099 33.0664 14.7891C33.582 15.263 34.2617 15.5 35.1055 15.5C36.3398 15.5 37.3138 14.9609 38.0273 13.8828C38.7461 12.8047 39.1055 11.2812 39.1055 9.3125H38.9805C38.6888 9.75 38.3424 10.1276 37.9414 10.4453C37.5404 10.763 37.0951 11.0078 36.6055 11.1797C36.1159 11.3516 35.5951 11.4375 35.043 11.4375C34.1263 11.4375 33.2852 11.2109 32.5195 10.7578C31.7591 10.2995 31.1497 9.67187 30.6914 8.875C30.2383 8.07292 30.0117 7.15625 30.0117 6.125C30.0117 5.14583 30.2305 4.25 30.668 3.4375C31.1107 2.61979 31.7305 1.96875 32.5273 1.48437C33.3294 1 34.2721 0.765625 35.3555 0.781249ZM35.3555 2.5C34.6992 2.5 34.1081 2.66406 33.582 2.99219C33.0612 3.3151 32.6471 3.7526 32.3398 4.30469C32.0378 4.85156 31.8867 5.45833 31.8867 6.125C31.8867 6.79167 32.0326 7.39844 32.3242 7.94531C32.6211 8.48698 33.0247 8.91927 33.5352 9.24219C34.0508 9.5599 34.6367 9.71875 35.293 9.71875C35.7878 9.71875 36.2487 9.6224 36.6758 9.42969C37.1029 9.23177 37.4753 8.96354 37.793 8.625C38.1159 8.28125 38.3685 7.89323 38.5508 7.46094C38.7331 7.02344 38.8242 6.56771 38.8242 6.09375C38.8242 5.46875 38.6732 4.88281 38.3711 4.33594C38.0742 3.78906 37.6628 3.34635 37.1367 3.00781C36.6159 2.66927 36.0221 2.5 35.3555 2.5Z" fill="white"/>
</svg>

{post?.favourites?.find(u=>u==user.id)?<svg className="cursor-pointer" onClick={()=>add_remove_reaction(post?._id,true)} width="25" height="20" viewBox="0 0 30 27" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M0 7.39905C0 -0.555782 11.4705 -3.50393 15 5.70484C18.5295 -3.50393 30 -0.555782 30 7.39905C30 16.0419 15 27 15 27C15 27 0 16.0419 0 7.39905Z" fill="#DD2E44"/>
</svg>
:<svg className="cursor-pointer" onClick={()=>add_remove_reaction(post?._id,false)} width="25" height="20" viewBox="0 0 30 27" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M21.75 0C19.125 0 16.6501 1.17717 15 3.09002C13.3498 1.17717 10.875 0 8.25 0C3.59986 0 0 3.53116 0 8.09262C0 13.6836 5.09986 18.1718 12.8247 25.0867L15 27L17.1753 25.0867C24.9001 18.1717 30 13.6835 30 8.09262C30 3.53116 26.4001 0 21.75 0ZM15.9257 23.1509L15.6214 23.4232L15 23.9697L14.3787 23.4233L14.0748 23.1512C10.4388 19.897 7.29873 17.0865 5.22288 14.5735C3.20675 12.1328 2.30769 10.134 2.30769 8.09262C2.30769 6.48492 2.91505 5.00372 4.01791 3.92196C5.11709 2.84379 6.62005 2.25 8.25 2.25C10.1347 2.25 11.9978 3.10549 13.2339 4.53832L15 6.58554L16.766 4.53832C18.0022 3.10549 19.8653 2.25 21.75 2.25C23.38 2.25 24.8829 2.84379 25.9822 3.92189C27.085 5.00372 27.6923 6.48485 27.6923 8.09262C27.6923 10.134 26.7932 12.1327 24.7773 14.5734C22.7015 17.0864 19.5615 19.8967 15.9257 23.1509Z" fill="white"/>
</svg>}


</div>

     </div>

        </div>
    )
}
export default Postcontent;